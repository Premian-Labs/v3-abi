#!/bin/bash

# To be able to run this on Windows : npm config set script-shell "C:\\Program Files\\git\\bin\\bash.exe"

# Exit on first error
set -e

# Delete stale temp directory if it exists
rm -rf ./temp

# Clone the repo and install dependencies
git clone -b master https://github.com/Premian-Labs/premia-v3-contracts-private.git ./temp
cd temp
yarn install
forge install

# Build and copy the contracts
forge build --extra-output-files abi
cd ..
ts-node ./copyAbi.ts

# Delete stale deployment directory if it exists
rm -rf ./deployment

# Copy the deployment files
mkdir ./deployment
cp -r ./temp/utils/deployment/arbitrum/metadata.json ./deployment/arbitrum.json
cp -r ./temp/utils/deployment/arbitrumGoerli/metadata.json ./deployment/arbitrumGoerli.json
cp -r ./temp/utils/deployment/arbitrumNova/metadata.json ./deployment/arbitrumNova.json
cp -r ./temp/utils/deployment/types.ts ./deployment/types.ts

echo "/* Autogenerated file. Do not edit manually. */" >> ./deployment/index.ts
echo "export { default as arbitrum } from './arbitrum.json';" >> ./deployment/index.ts
echo "export { default as arbitrumGoerli } from './arbitrumGoerli.json';" >> ./deployment/index.ts
echo "export { default as arbitrumNova } from './arbitrumNova.json';" >> ./deployment/index.ts
echo "export { DeploymentMetadata, ContractKey, ContractDeploymentMetadata, ContractType, DeploymentPath } from './types';" >> ./deployment/index.ts
