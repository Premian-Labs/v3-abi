#!/bin/bash

# To be able to run this on Windows : npm config set script-shell "C:\\Program Files\\git\\bin\\bash.exe"

# Exit on first error
set -e

# Delete stale temp directory if it exists
rm -rf ./temp

# Clone the repo and install dependencies
git clone -b master https://github.com/Premian-Labs/premia-v3-contracts-private.git ./temp
cd temp
yarn install
forge install

# Build and copy the contracts
forge build --extra-output-files abi
cd ..
ts-node ./utils/copyAbi.ts

# Delete stale deployment directory if it exists
rm -rf ./deployment

# Copy the deployment files
mkdir ./deployment
cp -r ./temp/utils/deployment/arbitrum/metadata.json ./deployment/arbitrum.json
cp -r ./temp/utils/deployment/arbitrumGoerli/metadata.json ./deployment/arbitrumGoerli.json
cp -r ./temp/utils/deployment/arbitrumNova/metadata.json ./deployment/arbitrumNova.json
cp -r ./temp/utils/deployment/types.ts ./deployment/types.ts

echo "/* Autogenerated file. Do not edit manually. */" >> ./deployment/index.ts
echo "import arbitrumMetadata from './arbitrum.json';" >> ./deployment/index.ts
echo "import arbitrumGoerliMetadata from './arbitrumGoerli.json';" >> ./deployment/index.ts
echo "import arbitrumNovaMetadata from './arbitrumNova.json';" >> ./deployment/index.ts
echo "import {ContractDeploymentMetadata, DeploymentMetadata} from './types';" >> ./deployment/index.ts
echo "export const arbitrum = arbitrumMetadata as DeploymentMetadata;" >> ./deployment/index.ts
echo "export const arbitrumGoerli = arbitrumGoerliMetadata as DeploymentMetadata;" >> ./deployment/index.ts
echo "export const arbitrumNova = arbitrumNovaMetadata as { core: { [key: string]: ContractDeploymentMetadata } };" >> ./deployment/index.ts

yarn codegen
tsc